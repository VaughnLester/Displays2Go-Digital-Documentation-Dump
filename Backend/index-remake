const http = require('http');   
const mysql = require('mysql2');
const urI = require('url'); 
const fs = require('fs'); 
const querystring = require('node:querystring');

const server = http.createServer((request, response)=>{
switch (request.url){
    case '/newSKU':
        let body = '';
        request.on('data', chunk =>{ 
            body += chunk.toString();
        });
        request.on('end', ()=>{
            response.writeHead(200, {  
            'Content-Type': 'text/html',
            'Access-Control-Allow-Origin' : '*'});   
            const newSKU = JSON.parse(JSON.stringify(querystring.parse(body))).newSKU; 
            connection.query(`CREATE TABLE ${newSKU} (entryID int NOT NULL AUTO_INCREMENT, Title varchar(255), Entry varchar(255) NOT NULL, PRIMARY KEY (entryID));`, (err, results) =>{
                if (err) {
                    console.log("error inserting data into database "+ err); return;  
                }
                else {
                console.log(`Created sku ${newSKU} successfully`);
                }
            })
            response.end(`Received data: ${JSON.stringify(parsedData)}`);
        });
        break;
    case '/addEntry':
        let body2 = '';
        request.on('data', chunk =>{ 
        body2 += chunk.toString();
        });
        request.on('end', ()=>{
        response.writeHead(200, {  
        'Content-Type': 'text/html',
        'Access-Control-Allow-Origin' : '*'});
        const existingSKU = JSON.parse(JSON.stringify(querystring.parse(body))).existingSKU;
        const title = JSON.parse(JSON.stringify(querystring.parse(body))).title;
        const entry = JSON.parse(JSON.stringify(querystring.parse(body))).entry;
        connection.query(`INSERT INTO ${existingSKU} (Title, Entry) VALUES ("${title}", "${entry}")`, (err, results) =>{
        if (err) {console.log("error inserting data into database "+ err); return;}
        else {
        console.log(existingSKU + " updated!");}
        })
        response.end(existingSKU + " updated: " + title + ", " + entry);
        });
        break;
    case "/allSKUs":
        connection.query('SHOW TABLES;', (err,results) =>{
            if (err){ 
            response.writeHead(200, {
            'Content-Type': 'text/html',
            'Access-Control-Allow-Origin' : '*'});
            response.end('error fetching data');
            return;
            }
            response.writeHead(200, { 
            'Content-Type': 'text/html',
            'Access-Control-Allow-Origin' : '*'});
            response.write(readTables(JSON.parse(JSON.stringify(results))));
            response.end();
            });
        break;    
}

switch(urI.parse(request.url, true).pathname){
    case "/skuPage":
        let body = " ";
        request.on('data', chunk => {body += chunk.toString()})
        request.on('end', ()=>{
            response.writeHead(200, {  
            'Content-Type': 'text/html',
            'Access-Control-Allow-Origin' : '*'});    
            const searchParams = new URLSearchParams(urI.parse(request.url, true).search);        
            const skuPage = searchParams.get('skuPage');
            connection.query(`SELECT * FROM ${skuPage}`, (err, results) =>{
            if (err) {console.log("error inserting data into database "+ err); return;}
            else {
            response.end("Table Name: " + skuPage + readRows(JSON.parse(JSON.stringify(results))));
            }
            })
            })
        break;
    case "/deleteSKU":
        let body2 = "";
        request.on('data', chunk => {body2 += chunk.toString()})
        request.on('end', ()=>{
            response.writeHead(200, {  
            'Content-Type': 'text/html',
            'Access-Control-Allow-Origin' : '*'});
            const deleteSKU = JSON.parse(JSON.stringify(querystring.parse(body2))).deleteSKU;
            connection.query(`DROP TABLE ${deleteSKU}`, (err, results) =>{
            if (err) {console.log("error inserting data into database "+ err); return;}
            else {
            response.end("Table Name: " + deleteSKU + " is deleted");
            }
            })
            })
        break;
    case "/deleteSkuEntry":
            
        break;
    case "/skuUpdateEntry":
        let body3 = "";
        request.on('data', chunk => {body3 += chunk.toString()})
        request.on('end', ()=>{
            response.writeHead(200, {  
            'Content-Type': 'text/html',
            'Access-Control-Allow-Origin' : '*'});
            connection.query(`UPDATE ${JSON.parse(JSON.stringify(querystring.parse(body))).skuNameUpdate} SET entry = "${JSON.parse(JSON.stringify(querystring.parse(body))).entryUpdate}" WHERE title = "${JSON.parse(JSON.stringify(querystring.parse(body))).title}"`, (err, results) =>{
            if (err) {console.log("error updating entry in SKU "+ err); return;}
            else {
            console.log("SKU entry update successful!");
            }
            })
            })
        break;
    case "/changeSkuName":
        let body4 = "";
        request.on('data', chunk => {body4 += chunk.toString()})
        request.on('end', ()=>{
            response.writeHead(200, {  
            'Content-Type': 'text/html',
            'Access-Control-Allow-Origin' : '*'});
            connection.query(`RENAME TABLE ${JSON.parse(JSON.stringify(querystring.parse(body))).sku} to ${JSON.parse(JSON.stringify(querystring.parse(body))).changeSkuName}`, (err, results) =>{
            if (err) {console.log("error inserting data into database "+ err); return;}
            else {
            console.log(JSON.parse(JSON.stringify(querystring.parse(body))).sku + " changed to " + JSON.parse(JSON.stringify(querystring.parse(body))).changeSkuName);
            }
            })
            })
        break;
}



//function :
//grab data from each row in database
function readRows(arr){
    let max = arr.length -1;
    let results = ' ';
    while (max > -1){
    results += `${arr[max].idTest} ${arr[max].text}, `
    max--;
    }
    return results;
}
//read each table 
function readTables(arr){
    let max = arr.length -1;
    let results = ' ';
    while (max > -1){
    results += `${arr[max].Tables_in_sql5768538}, `;
    //add link event listener -> goes to path that opens the table
    
    max--;
    }
    return results;
}


//DELETE
if (request.method === 'DELETE' && request.url === '/'){
console.log('delete path found');
let body = '';
request.on('data', chunk =>{ //chunk is the end of the url
body += chunk.toString();
});
request.on('end', ()=>{
const parsedData = querystring.parse(body); //parsing the end of the url - * The querystring. parse() method parses a URL query string ( str ) into a collection of key and value pairs * , aka JSON string
response.writeHead(200, {  
'Content-Type': 'text/html',
'Access-Control-Allow-Origin' : '*'});//enables CORS

//grabbing first and last name from the parsed url
const jsonString = JSON.stringify(parsedData);
const jsonObject = JSON.parse(jsonString);

const fname = jsonObject.fname;

//inserting first and last name into databse 
const sql = 'DELETE FROM test WHERE idtest = ?;'
connection.query(sql,[fname], (err, results) =>{
if (err) {console.log("error inserting data into database "+ err); return;}
else {
console.log("Database delete successful: " + fname + " deleted");}
})
response.end(`Received data: ${JSON.stringify(parsedData)}`);
})
}



//form submit confirmation
else if (parsedUrl.pathname == "/confirmation"){
response.writeHead(200, {
'Content-Type': 'text/html',
'Access-Control-Allow-Origin' : '*'});//enables CORS
fs.readFile('confirmation.html', function(err,content){
if(err){
console.log(err);
response.end;
}
else{
response.end(content);
}
})
}

//if no route is found - returning your index.html homepage from server!!!
else 
{
// response.writeHead(200, {
// 'Content-Type': 'text/html',
// 'Access-Control-Allow-Origin' : '*'});//enables CORS
// fs.createReadStream('index.html').pipe(response);
fs.readFile('index.html', function(err, content){
if (err){console.log("error occurred trying to send html file"); response.end}
else {
response.end(content);
}
})
// response.end('Not one of your designated endpoints! But we are connected!');
}
}
);

//creating database connection
const connection = mysql.createConnection({
host:'sql5.freesqldatabase.com',
user: 'sql5768538',
password: '9np9VjdEks',
database: 'sql5768538'
});

//connecting database
connection.connect(function(err)
{
if (err){console.log("error occurred while attempting connection: ", err)}
else {console.log("database connection successful!")}
}
);

function insertData(){
//inserting data into database
var data = "INSERT INTO test (idtest, text) VALUES ('1', 'This is sample text!')";
connection.query(data, function(err){
if (err) {console.log("error entering data into the database...");}
console.log("Data entry successful!");
});

//inserting more data into database

var data2 = "INSERT INTO test (idtest, text) VALUES ('2', 'sample text!')";
connection.query(data2, function(err){
if (err) {console.log("error entering data into the database...");}
console.log("Data entry successful!");
});
}

//pulling data from backend 
function pullData(){
var x = "";
var y = "original value";
var z = "";
connection.connect(function(err){
if(err){console.log("error occurred whilte attempting connection: ", err)}
else {console.log("database conncection successful")}
})
var data = "SELECT text FROM test where idtest = 1";

y =  connection.query(data, (err,results)=>{
if (err){return "there was an erro!";}
console.log("raw sql pull: " + results);
x = JSON.stringify(results);
console.log("raw pull stringify: " + x); //prints out correctly
y = JSON.parse(x);
console.log("raw pull stringify parsed: " + y);
console.log(y instanceof Object);
})
console.log("after the function: " + JSON.stringify(y)); //prints out incorrectly 
//x = JSON.stringify(y);
//z = JSON.parse(x);
return y;
}
//pullData();


//pull data from database and return an array:
var theData = "";
function returnData(){ //the problems is it's returning the QUERY itself and not the RESULTS! we need to extract the RESULTS and then stringy it in the response . write on the api 
var data = "SELECT text FROM test where idtest = 1";
var dataArray = "original value";
(connection.query(data, (err,results)=>{
if (err){return "there was an erro!";}
dataArray = results.map(row => Object.values(row));
theData = results;
return results;
}
))
}


console.log("new function" + JSON.stringify(returnData()));

//connecting server
server.listen(5001, console.log("server is listening on 5001"));



var wo = 5
function gg (){
wo =7;
}
gg();
console.log(wo);

console.log(JSON.stringify(returnData()));